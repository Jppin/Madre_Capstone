# utils/prompt_builder.py

def build_mealplan_prompt(
    user: dict,
    recommend_list: list[str],
    warning_list: list[str],
    avoided_foods: list[str],
    age: int,
    stage: str,
    bmi: float,
    kcal: int,
    macro_ratio: dict[str, str],
    micronutrients: dict[str, str],
    weight_gain_goal: float | None,
    medication_summary: str
) -> str:
    """
    Flask에서 받은 입력 데이터를 바탕으로 LLM에 보낼 Prompt 문자열을 반환.
    """

    # 1) 사용자 정보 블록(문자열 목록 생성)
    user_info_lines = [
        f"- 임신 단계: {stage} ({user.get('pregnancy', '')}"
        + (f" / {user.get('subPregnancy')}" if user.get("subPregnancy") else "")
        + ")",
        f"- 현재 임신 주차: {user.get('pregnancyWeek', '?')}주"
        + (f" (출산까지 약 {40 - user.get('pregnancyWeek', 0)}주 남음)" if user.get('pregnancyWeek') else ""),
        f"- 연령: {age}세",
        f"- 신체 정보: 키 {user.get('height', '?')}cm / 체중 {user.get('weight', '?')}kg / BMI: {bmi}",
        f"- 입덧 정도: {user.get('nausea', 0)}/5",
        f"- 만성질환 및 특이사항: {', '.join(user.get('conditions')) if user.get('conditions') else '없음'}",
        f"- 사용자 정보 기반 추천 성분: {', '.join(recommend_list) if recommend_list else '없음'}",
        f"- 주의해야 할 성분: {', '.join(warning_list) if warning_list else '없음'}",
        f"- 피해야 할 음식: {', '.join(avoided_foods) if avoided_foods else '없음'}",
        f"- 복용 중인 약 요약: {medication_summary or '없음'}",
        f"- 이번 주 체중 증가 목표: {weight_gain_goal if weight_gain_goal is not None else '없음'}"
    ]
    user_info_block = "## 사용자 정보\n" + "\n".join(user_info_lines)

    # 2) Prompt 전체 텍스트
    prompt = f"""
당신은 건강 정보를 바탕으로 **상태별 맞춤 식단을 제안하는 영양 전문가**입니다.  
아래 사용자 정보를 기반으로, **사용자 상태(만성질환, 복약, 체중, 임신 주차 등)를 적극 반영한 맞춤 식단**을 구성해주세요.  
특히 **사용자에게 중요한 건강 문제(예: 임신성 고혈압, 임신성 당뇨, 체중 증가, 복약 주의사항 등)**를 고려해  
**식단 테마**가 명확하게 드러나도록 작성해주세요.  
이 내용은 의학적 조언이 아닌 정보 제공을 위한 예시입니다. 

{user_info_block}

## 식단 테마 작성 가이드
- 사용자 건강 상태(예: 당뇨, 고혈압, 복약 내용 등)에 따라 **특정 목적(예: 혈당 조절, 나트륨 제한, 태아 성장 지원)**이 드러나는 **식단 테마 제목**을 설정해주세요.
- 테마 제목은 사용자에게 “왜 이 식단이 나에게 필요한지” 바로 와닿을 수 있도록 명확히 작성해주세요.
- 예:  
  - 체중 증가와 혈압 조절을 함께 고려한 임신 후기 맞춤 식단  
  - 위산 억제제 복용 중인 임산부를 위한 B12 강화 식단  
  - 임신성 당뇨 관리에 도움 되는 저당·고섬유 식단

## 영양 목표
- 총 섭취 열량: {kcal} kcal
- 탄수화물/단백질/지방 비율: {macro_ratio["탄수화물"]} / {macro_ratio["단백질"]} / {macro_ratio["지방"]}
- 주요 미량 영양소 고려 대상: {', '.join([f"{k}: {v}" for k, v in micronutrients.items()])}

---

## 식단 구성 지침
- 하루 식단은 **아침 / 점심 / 저녁 / 간식** 총 4끼로 구성해주세요.
- 하루 총 열량 {kcal} kcal을 기준으로, 각 끼니에 적절히 분배해주세요.
  일반적인 분배 비율은 **아침 25%, 점심 35%, 저녁 30%, 간식 10%**입니다.
- 각 끼니는 해당 열량 범위 내에서 **탄수화물 {macro_ratio["탄수화물"]}, 단백질 {macro_ratio["단백질"]}, 지방 {macro_ratio["지방"]}** 비율을 반영해주세요.
- 모든 음식은 **구체적인 명칭과 1인분 기준의 정확한 양**을 포함해주세요.
  예: 현미밥 1/2공기, 고등어구이 1토막, 사과 1/3개
- 하루 지방 섭취량 중 오메가-6와 오메가-3 지방산의 비율은 약 4:1~10:1 수준으로 구성해주세요.
- 오메가-3는 등푸른 생선(고등어, 연어 등)이나 들기름, 아마씨유 등을 활용해 구성할 수 있습니다.
  - **아침/점심/저녁 중 최소 2끼는 한식 스타일(밥, 국, 반찬 구성)**으로 구성해주세요.
- 한 끼 식사는 과하지 않은 양으로 구성하며, **작은 과일 또는 소량 디저트(예: 초콜릿 1~2조각)**는 허용됩니다.
- 간식은 **입덧, 식욕 저하, 기분 전환 등 건강 상태**를 고려해 부드러운 식품이나 기호식품으로 구성하되, **고열량 간식은 피해주세요.**
  예: 부드러운 요거트, 무가당 두유, 사과 한 조각 등
- 각 끼니의 설명은 **섭취 시점, 건강 효과, 추천 이유**를 포함하여 **2~3문장 이내**로 작성해주세요.
---

## 출력 형식

[식단 테마]
- 테마:
- 테마 설명:

[아침]
- 추천 메뉴:
- 주의할 점:
- 설명:
- 이런 상태라면 더 좋아요:
- 똑똑한 팁:

[점심]
- 추천 메뉴:
- 주의할 점:
- 설명:
- 이런 상태라면 더 좋아요:
- 똑똑한 팁:

[저녁]
- 추천 메뉴:
- 주의할 점:
- 설명:
- 이런 상태라면 더 좋아요:
- 똑똑한 팁:

[간식]
- 추천 메뉴:
- 주의할 점:
- 설명:
- 이런 상태라면 더 좋아요:
- 똑똑한 팁:

---

## 하루 식단 종합 가이드 작성 지침

- 아래 3개 블록을 반드시 포함해주세요:  
  [섭취 충족도 분석], [추가 섭취 가이드], [복용 주의사항]

- 각 블록은 제목을 대괄호로 감싸고, 다음 규칙을 지켜주세요.

### [섭취 충족도 분석]
- `- 영양소: XX%` 형태의 리스트로 작성해주세요.
- 예:  
  - 엽산: 90%  
  - 철분: 75%

### [추가 섭취 가이드]
- `- 권장 영양제:` 아래에 줄바꿈된 리스트 형식으로 작성해주세요.
- `- 설명:` 뒤에 1~3문장으로 보충 이유를 설명해주세요.
- 예:  
  - 권장 영양제:  
    철분제 30~50mg  
    엽산 400~600μg  
  - 설명:  
    엽산과 철분은 임신 초기 태아 성장에 중요한 역할을 하며, 식단만으로는 부족할 수 있습니다.

### [복용 주의사항]
- `-`로 시작된 간단한 조언 2~4줄로 작성해주세요.
- 예:  
  - 엽산은 식사 중에 복용하는 것이 좋습니다.  
  - 철분제는 우유와 함께 복용하지 마세요.


""".strip()

    return prompt
